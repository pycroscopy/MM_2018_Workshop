

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pycroscopy.processing.image_processing &mdash; pycroscopy 0.60.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> pycroscopy
          

          
            
            <img src="../../../_static/logo_v01.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.60.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">Pycroscopy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_guides.html">Tutorials on Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package_organization.html">Package Organization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Examples &amp; Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../translators.html">Data Translators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../papers_conferences.html">Papers / Conferences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contact.html">Contact us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../whats_new.html">Whatâ€™s New</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pycroscopy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pycroscopy.processing.image_processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pycroscopy.processing.image_processing</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Jun 16, 2016</span>

<span class="sd">@author: Chris Smith -- csmith55@utk.edu</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">cpu_count</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">leastsq</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">blackman</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="k">import</span> <span class="n">gen_batches</span>

<span class="kn">from</span> <span class="nn">pyUSID</span> <span class="k">import</span> <span class="n">USIDataset</span>
<span class="kn">from</span> <span class="nn">pyUSID.io.hdf_utils</span> <span class="k">import</span> <span class="n">get_h5_obj_refs</span><span class="p">,</span> <span class="n">copy_attributes</span><span class="p">,</span> <span class="n">link_h5_objects_as_attrs</span><span class="p">,</span> <span class="n">find_results_groups</span><span class="p">,</span> \
    <span class="n">link_as_main</span><span class="p">,</span> <span class="n">check_for_old</span>
<span class="kn">from</span> <span class="nn">pyUSID.io.io_utils</span> <span class="k">import</span> <span class="n">get_available_memory</span>
<span class="kn">from</span> <span class="nn">pyUSID.io.write_utils</span> <span class="k">import</span> <span class="n">make_indices_matrix</span><span class="p">,</span> <span class="n">get_aux_dset_slicing</span><span class="p">,</span> <span class="n">INDICES_DTYPE</span><span class="p">,</span> <span class="n">VALUES_DTYPE</span><span class="p">,</span> <span class="n">calc_chunks</span>
<span class="kn">from</span> <span class="nn">..io.hdf_writer</span> <span class="k">import</span> <span class="n">HDFwriter</span>
<span class="kn">from</span> <span class="nn">..io.virtual_data</span> <span class="k">import</span> <span class="n">VirtualGroup</span><span class="p">,</span> <span class="n">VirtualDataset</span>
<span class="kn">from</span> <span class="nn">.svd_utils</span> <span class="k">import</span> <span class="n">get_component_slice</span>

<span class="n">windata32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]})</span>
<span class="n">absfft32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;FFT Magnitude&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]})</span>
<span class="n">winabsfft32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">,</span> <span class="s1">&#39;FFT Magnitude&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]})</span>
<span class="n">wincompfft32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">,</span> <span class="s1">&#39;FFT Real&#39;</span><span class="p">,</span> <span class="s1">&#39;FFT Imag&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]})</span>


<div class="viewcode-block" id="ImageWindow"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow">[docs]</a><span class="k">class</span> <span class="nc">ImageWindow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class will handle the reading of a raw image file, creating windows from it, and writing those</span>
<span class="sd">    windows to an HDF5 file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_main</span><span class="p">,</span> <span class="n">max_RAM_mb</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">image_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the image windowing</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_main : h5py.Dataset</span>
<span class="sd">            HDF5 Dataset containing the data to be windowed</span>
<span class="sd">        max_RAM_mb : int, optional</span>
<span class="sd">            integer maximum amount of ram, in Mb, to use in windowing</span>
<span class="sd">            Default 1024</span>
<span class="sd">        cores : int, optional</span>
<span class="sd">            integer number of [logical] CPU cores to use in windowing</span>
<span class="sd">            Defualt None, use number of available cores minus 2</span>
<span class="sd">        reset : Boolean, optional</span>
<span class="sd">            should all data in the hdf5 file be deleted</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_file</span> <span class="o">=</span> <span class="n">h5_main</span><span class="o">.</span><span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span> <span class="o">=</span> <span class="n">HDFwriter</span><span class="p">(</span><span class="n">h5_main</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Ensuring that at least one core is available for use / 2 cores are available for other use</span>
        <span class="n">max_cores</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#         print &#39;max_cores&#39;,max_cores</span>
        <span class="k">if</span> <span class="n">cores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cores</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cores</span><span class="p">)),</span> <span class="n">max_cores</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cores</span> <span class="o">=</span> <span class="n">max_cores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_RAM_mb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">get_available_memory</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize class variables to None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span> <span class="o">=</span> <span class="n">h5_main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_norm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_wins</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_clean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_noise</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_fft_clean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_fft_noise</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ImageWindow.do_windowing"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.do_windowing">[docs]</a>    <span class="k">def</span> <span class="nf">do_windowing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win_step_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">win_step_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">win_fft</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the windows from the normalized image and write them to the file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        win_x : int, optional</span>
<span class="sd">            size of the window, in pixels, in the horizontal direction</span>
<span class="sd">            Default None, a guess will be made based on the FFT of the image</span>
<span class="sd">        win_y : int, optional</span>
<span class="sd">            size of the window, in pixels, in the vertical direction</span>
<span class="sd">            Default None, a guess will be made based on the FFT of the image</span>
<span class="sd">        win_step_x : int, optional</span>
<span class="sd">            step size, in pixels, to take between windows in the horizontal direction</span>
<span class="sd">            Default 1</span>
<span class="sd">        win_step_y : int, optional</span>
<span class="sd">            step size, in pixels, to take between windows in the vertical direction</span>
<span class="sd">            Default 1</span>
<span class="sd">        win_fft : str, optional</span>
<span class="sd">            What kind of fft should be stored with the windows.  Options are</span>
<span class="sd">            None - Only the window</span>
<span class="sd">            &#39;abs&#39; - Only the magnitude of the fft</span>
<span class="sd">            &#39;data+abs&#39; - The window and magnitude of the fft</span>
<span class="sd">            &#39;data+complex&#39; - The window and the complex fft</span>
<span class="sd">            Default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        h5_wins : HDF5 Dataset</span>
<span class="sd">            Dataset containing the flattened windows</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h5_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span>

        <span class="k">if</span> <span class="n">win_fft</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span> <span class="ow">or</span> <span class="n">win_fft</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">win_fft</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
            <span class="n">win_type</span> <span class="o">=</span> <span class="n">windata32</span>
            <span class="n">win_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_data_func</span>
        <span class="k">elif</span> <span class="n">win_fft</span> <span class="o">==</span> <span class="s1">&#39;abs&#39;</span><span class="p">:</span>
            <span class="n">win_type</span> <span class="o">=</span> <span class="n">absfft32</span>
            <span class="n">win_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_fft_func</span>
        <span class="k">elif</span> <span class="n">win_fft</span> <span class="o">==</span> <span class="s1">&#39;data+abs&#39;</span><span class="p">:</span>
            <span class="n">win_type</span> <span class="o">=</span> <span class="n">winabsfft32</span>
            <span class="n">win_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_abs_fft_func</span>
        <span class="k">elif</span> <span class="n">win_fft</span> <span class="o">==</span> <span class="s1">&#39;data+complex&#39;</span><span class="p">:</span>
            <span class="n">win_type</span> <span class="o">=</span> <span class="n">wincompfft32</span>
            <span class="n">win_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_comp_fft_func</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Invalid FFT option supplied.  Windowing will default to data only.&#39;</span><span class="p">)</span>
            <span class="n">win_fft</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
            <span class="n">win_type</span> <span class="o">=</span> <span class="n">windata32</span>
            <span class="n">win_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_data_func</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If a window size has not been specified, obtain a guess value from </span>
<span class="sd">        window_size_extract</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">win_test</span><span class="p">,</span> <span class="n">psf_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size_extract</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">win_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">win_x</span> <span class="o">=</span> <span class="n">win_test</span>
        <span class="k">if</span> <span class="n">win_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">win_y</span> <span class="o">=</span> <span class="n">win_test</span>

        <span class="n">image</span><span class="p">,</span> <span class="n">h5_wins</span><span class="p">,</span> <span class="n">win_pos_mat</span><span class="p">,</span> <span class="n">have_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_window_h5</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="n">psf_width</span><span class="p">,</span> <span class="n">win_fft</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span>
                                                                      <span class="n">win_step_y</span><span class="p">,</span> <span class="n">win_type</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">have_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5_wins</span> <span class="o">=</span> <span class="n">h5_wins</span>
            <span class="k">return</span> <span class="n">h5_wins</span>

        <span class="n">n_wins</span> <span class="o">=</span> <span class="n">win_pos_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">win_pix</span> <span class="o">=</span> <span class="n">win_x</span> <span class="o">*</span> <span class="n">win_y</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create slice object from the positions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">win_slices</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">win_x</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">win_y</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">win_pos_mat</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the size of a given batch that will fit in the available memory</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mem_per_win</span> <span class="o">=</span> <span class="n">win_x</span> <span class="o">*</span> <span class="n">win_y</span> <span class="o">*</span> <span class="n">h5_wins</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">free_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free_mem</span> <span class="o">/</span> <span class="n">mem_per_win</span><span class="p">)</span>
        <span class="n">batch_slices</span> <span class="o">=</span> <span class="n">gen_batches</span><span class="p">(</span><span class="n">n_wins</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ibatch</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_slices</span><span class="p">):</span>
            <span class="n">batch_wins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">batch</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">batch</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">win_pix</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">win_type</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Read each slice and write it to the dataset</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">islice</span><span class="p">,</span> <span class="n">this_slice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">win_slices</span><span class="p">[</span><span class="n">batch</span><span class="p">]):</span>
                <span class="n">iwin</span> <span class="o">=</span> <span class="n">ibatch</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="n">islice</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="n">iwin</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">n_wins</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="n">per_done</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">iwin</span> <span class="o">/</span> <span class="n">n_wins</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Windowing Image...</span><span class="si">{}</span><span class="s1">% --pixels </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">, step # </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">per_done</span><span class="p">,</span>
                                                                                   <span class="p">(</span><span class="n">this_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                                                                    <span class="n">this_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                                                                                   <span class="p">(</span><span class="n">this_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                                                                                    <span class="n">this_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span>
                                                                                   <span class="n">islice</span><span class="p">))</span>

                <span class="n">batch_wins</span><span class="p">[</span><span class="n">islice</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_func</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">this_slice</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="n">h5_wins</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_wins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5_wins</span> <span class="o">=</span> <span class="n">h5_wins</span>

        <span class="k">return</span> <span class="n">USIDataset</span><span class="p">(</span><span class="n">h5_wins</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_win_parameters</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the window parameters</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_main : h5py.Dataset</span>
<span class="sd">            Dataset containing the Raw Image</span>
<span class="sd">        win_step_x : uint</span>
<span class="sd">            Step size in the x-direction between windows.</span>
<span class="sd">        win_step_y : uint</span>
<span class="sd">            Step size in the y-direction between windows.</span>
<span class="sd">        win_x : uint</span>
<span class="sd">            Size of the window in the x-direction.</span>
<span class="sd">        win_y : uint</span>
<span class="sd">            Size of the window in the y-direction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            Array containing the original image reshaped by position.</span>
<span class="sd">        win_step_x : uint</span>
<span class="sd">            Step size in the x-direction between windows.</span>
<span class="sd">        win_step_y : uint</span>
<span class="sd">            Step size in the y-direction between windows.</span>
<span class="sd">        win_x : uint</span>
<span class="sd">            Size of the window in the x-direction.</span>
<span class="sd">        win_y : uint</span>
<span class="sd">            Size of the window in the y-direction.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the position indices of h5_main and reshape the flattened image back</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h5_pos</span> <span class="o">=</span> <span class="n">h5_main</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">h5_main</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">]][()]</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">h5_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">h5_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Position Indices dataset does not exist</span>
<span class="sd">            Assume square image</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h5_main</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="n">x_pix</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">h5_main</span><span class="p">[()]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">y_pix</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Step size must be less than 1/4th the image size</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="n">win_step_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_pix</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">)</span>
        <span class="n">win_step_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_pix</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Prevent windows from being less that twice the step size and more than half the image size</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="n">win_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">win_x</span><span class="p">))</span>
        <span class="n">win_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">win_y</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimal window size determined to be </span><span class="si">{wx}</span><span class="s1">x</span><span class="si">{wy}</span><span class="s1"> pixels.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wx</span><span class="o">=</span><span class="n">win_x</span><span class="p">,</span> <span class="n">wy</span><span class="o">=</span><span class="n">win_y</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span>

    <span class="k">def</span> <span class="nf">_setup_window_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_main</span><span class="p">,</span> <span class="n">psf_width</span><span class="p">,</span> <span class="n">win_fft</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="n">win_type</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span>
                         <span class="n">win_y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the hdf5 group for the windows</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_main : h5py.Dataset</span>
<span class="sd">            Dataset containing the Raw Image</span>
<span class="sd">        psf_width : uint</span>
<span class="sd">            psf_width???  Someone who knows what this is should fill it in </span>
<span class="sd">        win_fft : </span>
<span class="sd">        win_step_x : uint</span>
<span class="sd">            Step size in the x-direction between windows.</span>
<span class="sd">        win_step_y : uint</span>
<span class="sd">            Step size in the y-direction between windows.</span>
<span class="sd">        win_type</span>
<span class="sd">        win_x : uint</span>
<span class="sd">            Size of the window in the x-direction.</span>
<span class="sd">        win_y : uint</span>
<span class="sd">            Size of the window in the y-direction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_win_parameters</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span>
                                                                                 <span class="n">win_step_x</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span>
                                                                                 <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Build the Spectroscopic and Position Datasets </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ds_pix_inds</span><span class="p">,</span> <span class="n">ds_pix_vals</span><span class="p">,</span> <span class="n">ds_pos_inds</span><span class="p">,</span> <span class="n">ds_pos_vals</span><span class="p">,</span> <span class="n">win_pos_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_window_pos_spec</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">)</span>
        <span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">n_wins</span> <span class="o">=</span> <span class="n">win_pos_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">win_pix</span> <span class="o">=</span> <span class="n">win_x</span> <span class="o">*</span> <span class="n">win_y</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the chunk size</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">win_chunks</span> <span class="o">=</span> <span class="n">calc_chunks</span><span class="p">([</span><span class="n">n_wins</span><span class="p">,</span> <span class="n">win_pix</span><span class="p">],</span> <span class="n">win_type</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span> <span class="n">unit_chunks</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">win_pix</span><span class="p">])</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="n">h5_main</span><span class="o">.</span><span class="n">parent</span>

        <span class="n">check_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fft_mode&#39;</span><span class="p">:</span> <span class="n">win_fft</span><span class="p">,</span>
                            <span class="s1">&#39;psf_width&#39;</span><span class="p">:</span> <span class="n">psf_width</span><span class="p">,</span>
                            <span class="s1">&#39;win_x&#39;</span><span class="p">:</span> <span class="n">win_x</span><span class="p">,</span>
                            <span class="s1">&#39;win_y&#39;</span><span class="p">:</span> <span class="n">win_y</span><span class="p">,</span>
                            <span class="s1">&#39;win_step_x&#39;</span><span class="p">:</span> <span class="n">win_step_x</span><span class="p">,</span>
                            <span class="s1">&#39;win_step_y&#39;</span><span class="p">:</span> <span class="n">win_step_y</span><span class="p">,</span>
                            <span class="s1">&#39;image_x&#39;</span><span class="p">:</span> <span class="n">im_x</span><span class="p">,</span>
                            <span class="s1">&#39;image_y&#39;</span><span class="p">:</span> <span class="n">im_y</span><span class="p">}</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">h5_main</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">old_group</span> <span class="o">=</span> <span class="n">check_for_old</span><span class="p">(</span><span class="n">h5_main</span><span class="p">,</span> <span class="s1">&#39;-Windowing&#39;</span><span class="p">,</span> <span class="n">check_parameters</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">old_group</span> <span class="o">=</span> <span class="n">old_group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">old</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">h5_wins</span> <span class="o">=</span> <span class="n">old_group</span><span class="p">[</span><span class="s1">&#39;Image_Windows&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create the Windows Dataset and Datagroup</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">ds_windows</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Image_Windows&#39;</span><span class="p">,</span>
                                        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">maxshape</span><span class="o">=</span><span class="p">[</span><span class="n">n_wins</span><span class="p">,</span> <span class="n">win_pix</span><span class="p">],</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">win_type</span><span class="p">,</span>
                                        <span class="n">chunking</span><span class="o">=</span><span class="n">win_chunks</span><span class="p">,</span>
                                        <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span>
                                        <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="s1">&#39;Intensity&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;a.u.&#39;</span><span class="p">})</span>

            <span class="n">ds_group</span> <span class="o">=</span> <span class="n">VirtualGroup</span><span class="p">(</span><span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;-Windowing_&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">add_children</span><span class="p">([</span><span class="n">ds_windows</span><span class="p">,</span> <span class="n">ds_pos_inds</span><span class="p">,</span> <span class="n">ds_pix_inds</span><span class="p">,</span>
                                   <span class="n">ds_pos_vals</span><span class="p">,</span> <span class="n">ds_pix_vals</span><span class="p">])</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_x</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_y</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_step_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_step_x</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_step_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_step_y</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_x</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_y</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;psf_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_width</span>
            <span class="n">ds_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fft_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_fft</span>
            <span class="n">image_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ds_group</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Get the hdf5 objects for the windows and ancillary datasets</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">h5_wins</span> <span class="o">=</span> <span class="n">get_h5_obj_refs</span><span class="p">([</span><span class="s1">&#39;Image_Windows&#39;</span><span class="p">],</span> <span class="n">image_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Link references to windowed dataset</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">aux_ds_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">,</span> <span class="s1">&#39;Position_Values&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectroscopic_Indices&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">]</span>
            <span class="n">link_h5_objects_as_attrs</span><span class="p">(</span><span class="n">h5_wins</span><span class="p">,</span> <span class="n">get_h5_obj_refs</span><span class="p">(</span><span class="n">aux_ds_names</span><span class="p">,</span> <span class="n">image_refs</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">h5_wins</span><span class="p">,</span> <span class="n">win_pos_mat</span><span class="p">,</span> <span class="n">old</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_window_pos_spec</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the position and spectroscopic datasets for the windows.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            Raw Image</span>
<span class="sd">        win_step_x : uint</span>
<span class="sd">            Step size in the x-direction between windows.</span>
<span class="sd">        win_step_y : uint</span>
<span class="sd">            Step size in the y-direction between windows.</span>
<span class="sd">        win_x : uint</span>
<span class="sd">            Size of the window in the x-direction.</span>
<span class="sd">        win_y : uint</span>
<span class="sd">            Size of the window in the y-direction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds_pix_inds : VirtualDataset</span>
<span class="sd">            Spectroscopic Indices of the windows</span>
<span class="sd">        ds_pix_vals : VirtualDataset</span>
<span class="sd">            Spectroscopic Values of the windows</span>
<span class="sd">        ds_pos_inds : VirtualDataset</span>
<span class="sd">            Position Indices of the windows</span>
<span class="sd">        ds_pos_vals : VirtualDataset</span>
<span class="sd">            Position Values of the windows</span>
<span class="sd">        win_pos_mat : numpy.ndarray</span>
<span class="sd">            Array containing the positions of the window origins</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_x</span> <span class="o">-</span> <span class="n">win_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">y_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_y</span> <span class="o">-</span> <span class="n">win_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_steps</span><span class="p">)</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_steps</span><span class="p">)</span>
        <span class="n">win_pos_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">x_steps</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y_steps</span><span class="p">,</span> <span class="n">nx</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">win_pix_mat</span> <span class="o">=</span> <span class="n">make_indices_matrix</span><span class="p">([</span><span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the HDF5 Group and Datasets for the windowed data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ds_pos_inds</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">win_pos_mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">INDICES_DTYPE</span><span class="p">)</span>
        <span class="n">ds_pix_inds</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Spectroscopic_Indices&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">win_pix_mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">INDICES_DTYPE</span><span class="p">)</span>
        <span class="n">ds_pos_vals</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Position_Values&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">win_pos_mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">VALUES_DTYPE</span><span class="p">)</span>
        <span class="n">ds_pix_vals</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">win_pix_mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">VALUES_DTYPE</span><span class="p">)</span>
        <span class="n">pos_labels</span> <span class="o">=</span> <span class="n">get_aux_dset_slicing</span><span class="p">([</span><span class="s1">&#39;Window Origin X&#39;</span><span class="p">,</span> <span class="s1">&#39;Window Origin Y&#39;</span><span class="p">],</span> <span class="n">is_spectroscopic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ds_pos_inds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_labels</span>
        <span class="n">ds_pos_inds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">]</span>
        <span class="n">ds_pos_vals</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_labels</span>
        <span class="n">ds_pos_vals</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">]</span>
        <span class="n">pix_labels</span> <span class="o">=</span> <span class="n">get_aux_dset_slicing</span><span class="p">([</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">],</span> <span class="n">is_spectroscopic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ds_pix_inds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pix_labels</span>
        <span class="n">ds_pix_inds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">]</span>
        <span class="n">ds_pix_vals</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pix_labels</span>
        <span class="n">ds_pix_vals</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ds_pix_inds</span><span class="p">,</span> <span class="n">ds_pix_vals</span><span class="p">,</span> <span class="n">ds_pos_inds</span><span class="p">,</span> <span class="n">ds_pos_vals</span><span class="p">,</span> <span class="n">win_pos_mat</span>

<div class="viewcode-block" id="ImageWindow.win_data_func"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.win_data_func">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">win_data_func</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the input image in the `windata32` format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            Windowed image to take the FFT of</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        windows : numpy.ndarray</span>
<span class="sd">            Array the image in the windata32 format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">windata32</span><span class="p">)</span>
        <span class="n">windows</span><span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>

        <span class="k">return</span> <span class="n">windows</span></div>

<div class="viewcode-block" id="ImageWindow.abs_fft_func"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.abs_fft_func">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">abs_fft_func</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take the 2d FFT of each window in `windows` and return in the proper form.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            Windowed image to take the FFT of</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        windows : numpy.ndarray</span>
<span class="sd">            Array of the Magnitude of the FFT of each window for the input</span>
<span class="sd">            `image`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">absfft32</span><span class="p">)</span>
        <span class="n">windows</span><span class="p">[</span><span class="s1">&#39;FFT Magnitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">windows</span></div>

<div class="viewcode-block" id="ImageWindow.win_abs_fft_func"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.win_abs_fft_func">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">win_abs_fft_func</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take the 2d FFT of each window in `windows` and return in the proper form.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            Windowed image to take the FFT of</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        windows : numpy.ndarray</span>
<span class="sd">            Array of windows and the Magnitude of the FFT of each window for the input</span>
<span class="sd">            `image`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">winabsfft32</span><span class="p">)</span>
        <span class="n">windows</span><span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">windows</span><span class="p">[</span><span class="s1">&#39;FFT Magnitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">windows</span></div>

<div class="viewcode-block" id="ImageWindow.win_comp_fft_func"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.win_comp_fft_func">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">win_comp_fft_func</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take the 2d FFT of each window in `windows` and return in the proper form.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            Windowed image to take the FFT of</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        windows : numpy.ndarray</span>
<span class="sd">            Array of windows and the FFT of each window for the input `image`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wincompfft32</span><span class="p">)</span>
        <span class="n">windows</span><span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
        <span class="n">win_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
        <span class="n">windows</span><span class="p">[</span><span class="s1">&#39;FFT Real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_fft</span><span class="o">.</span><span class="n">real</span>
        <span class="n">windows</span><span class="p">[</span><span class="s1">&#39;FFT Imag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">win_fft</span><span class="o">.</span><span class="n">imag</span>

        <span class="k">return</span> <span class="n">windows</span></div>

<div class="viewcode-block" id="ImageWindow.build_clean_image"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.build_clean_image">[docs]</a>    <span class="k">def</span> <span class="nf">build_clean_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_win</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstructs the cleaned image from the windowed dataset</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_win : HDF5 dataset , optional</span>
<span class="sd">            The windowed image to be reconstructed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        h5_clean : HDF5 dataset</span>
<span class="sd">            The cleaned image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">h5_win</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_wins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;You must clean the image before rebuilding it.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">h5_win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_wins</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get basic windowing information from attributes of </span>
<span class="sd">        h5_win</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">im_x</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_x&#39;</span><span class="p">]</span>
        <span class="n">im_y</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_y&#39;</span><span class="p">]</span>
        <span class="n">win_x</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_x&#39;</span><span class="p">]</span>
        <span class="n">win_y</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_y&#39;</span><span class="p">]</span>
        <span class="n">win_step_x</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_step_x&#39;</span><span class="p">]</span>
        <span class="n">win_step_y</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_step_x&#39;</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the steps taken to create original windows</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">x_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_x</span> <span class="o">-</span> <span class="n">win_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">win_step_x</span><span class="p">)</span>
        <span class="n">y_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_y</span> <span class="o">-</span> <span class="n">win_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">win_step_y</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize arrays to hold summed windows and counts for each position</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_steps</span><span class="p">)</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_steps</span><span class="p">)</span>
        <span class="n">n_wins</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create slice object from the positions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">win_slices</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">win_x</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">win_y</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_steps</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">y_steps</span><span class="p">,</span> <span class="n">ny</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loop over all windows.  Increment counts for window positions and </span>
<span class="sd">        add current window to total.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">counts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">islice</span><span class="p">,</span> <span class="n">this_slice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">win_slices</span><span class="p">):</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="n">islice</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">n_wins</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
                <span class="n">per_done</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">islice</span> <span class="o">/</span> <span class="n">n_wins</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructing Image...</span><span class="si">{}% -- s</span><span class="s1">tep # </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">per_done</span><span class="p">,</span> <span class="n">islice</span><span class="p">))</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">this_slice</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ones</span>

            <span class="n">accum</span><span class="p">[</span><span class="n">this_slice</span><span class="p">]</span> <span class="o">+=</span> <span class="n">h5_win</span><span class="p">[</span><span class="n">islice</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">)</span>

        <span class="n">clean_image</span> <span class="o">=</span> <span class="n">accum</span> <span class="o">/</span> <span class="n">counts</span>

        <span class="n">clean_image</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">clean_image</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">clean_grp</span> <span class="o">=</span> <span class="n">VirtualGroup</span><span class="p">(</span><span class="s1">&#39;Cleaned_Image&#39;</span><span class="p">,</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">ds_clean</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Cleaned_Image&#39;</span><span class="p">,</span> <span class="n">clean_image</span><span class="p">)</span>

        <span class="n">clean_grp</span><span class="o">.</span><span class="n">add_children</span><span class="p">([</span><span class="n">ds_clean</span><span class="p">])</span>

        <span class="n">image_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">clean_grp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">h5_clean</span> <span class="o">=</span> <span class="n">get_h5_obj_refs</span><span class="p">([</span><span class="s1">&#39;Cleaned_Image&#39;</span><span class="p">],</span> <span class="n">image_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5_clean</span> <span class="o">=</span> <span class="n">h5_clean</span>

        <span class="k">return</span> <span class="n">h5_clean</span></div>

    <span class="c1"># def clean_and_build(self, h5_win=None, components=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Rebuild the Image from the SVD results on the windows</span>
    <span class="c1">#     Optionally, only use components less than n_comp.</span>
    <span class="c1">#</span>
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     h5_win : hdf5 Dataset, optional</span>
    <span class="c1">#         dataset containing the windowed image which SVD was performed on</span>
    <span class="c1">#     components: {int, iterable of int, slice} optional</span>
    <span class="c1">#         Defines which components to keep</span>
    <span class="c1">#</span>
    <span class="c1">#         Input Types</span>
    <span class="c1">#         integer : Components less than the input will be kept</span>
    <span class="c1">#         length 2 iterable of integers : Integers define start and stop of component slice to retain</span>
    <span class="c1">#         other iterable of integers or slice : Selection of component indices to retain</span>
    <span class="c1">#</span>
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     clean_wins : HDF5 Dataset</span>
    <span class="c1">#         the cleaned windows</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     if h5_win is None:</span>
    <span class="c1">#         if self.h5_wins is None:</span>
    <span class="c1">#             warn(&#39;You must perform windowing on an image followed by SVD on the window before you can clean it.&#39;)</span>
    <span class="c1">#             return</span>
    <span class="c1">#         h5_win = self.h5_wins</span>
    <span class="c1">#     elif &#39;Image Data&#39; not in h5_win.dtype.names:</span>
    <span class="c1">#         warn(&#39;The windows must have the real space image data in them to rebuild.&#39;)</span>
    <span class="c1">#         return</span>
    <span class="c1">#</span>
    <span class="c1">#     print(&#39;Cleaning the image by removing unwanted components.&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     comp_slice = _get_component_slice(components)</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Read the 1st n_comp components from the SVD results</span>
    <span class="c1">#     on h5_win</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     win_name = h5_win.name.split(&#39;/&#39;)[-1]</span>
    <span class="c1">#</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         win_svd = find_results_groups(h5_win, &#39;SVD&#39;)[-1]</span>
    <span class="c1">#</span>
    <span class="c1">#         h5_S = win_svd[&#39;S&#39;]</span>
    <span class="c1">#         h5_U = win_svd[&#39;U&#39;]</span>
    <span class="c1">#         h5_V = win_svd[&#39;V&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     except KeyError:</span>
    <span class="c1">#         warnstring = &#39;SVD Results for {dset} were not found in {file}.&#39;.format(dset=win_name, file=self.image_path)</span>
    <span class="c1">#         warn(warnstring)</span>
    <span class="c1">#         return</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         raise</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Get basic windowing information from attributes of</span>
    <span class="c1">#     h5_win</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     im_x = h5_win.parent.attrs[&#39;image_x&#39;]</span>
    <span class="c1">#     im_y = h5_win.parent.attrs[&#39;image_y&#39;]</span>
    <span class="c1">#     win_x = h5_win.parent.attrs[&#39;win_x&#39;]</span>
    <span class="c1">#     win_y = h5_win.parent.attrs[&#39;win_y&#39;]</span>
    <span class="c1">#     win_step_x = h5_win.parent.attrs[&#39;win_step_x&#39;]</span>
    <span class="c1">#     win_step_y = h5_win.parent.attrs[&#39;win_step_x&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Calculate the steps taken to create original windows</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     x_steps = np.arange(0, im_x - win_x, win_step_x)</span>
    <span class="c1">#     y_steps = np.arange(0, im_y - win_y, win_step_y)</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Initialize arrays to hold summed windows and counts for each position</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     counts = np.zeros([im_x, im_y], np.uint32)</span>
    <span class="c1">#     clean_image = np.zeros([im_x, im_y], np.float32)</span>
    <span class="c1">#</span>
    <span class="c1">#     nx = len(x_steps)</span>
    <span class="c1">#     ny = len(y_steps)</span>
    <span class="c1">#     n_wins = nx * ny</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Create slice object from the positions</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     h5_win_pos = h5_win.file[h5_win.attrs[&#39;Position_Indices&#39;]]</span>
    <span class="c1">#     win_slices = [[slice(x, x + win_x), slice(y, y + win_y)] for x, y in h5_win_pos]</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Loop over all windows.  Increment counts for window positions and</span>
    <span class="c1">#     add current window to total.</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     ones = np.ones([win_x, win_y], dtype=counts.dtype)</span>
    <span class="c1">#     ds_V = np.dot(np.diag(h5_S[comp_slice]), h5_V[&#39;Image_Data&#39;][comp_slice, :])</span>
    <span class="c1">#</span>
    <span class="c1">#     for islice, this_slice in enumerate(win_slices):</span>
    <span class="c1">#         if islice % np.rint(n_wins / 10) == 0:</span>
    <span class="c1">#             per_done = np.rint(100 * islice / n_wins)</span>
    <span class="c1">#             print(&#39;Reconstructing Image...{}% -- step # {}&#39;.format(per_done, islice))</span>
    <span class="c1">#</span>
    <span class="c1">#         counts[this_slice] += ones</span>
    <span class="c1">#</span>
    <span class="c1">#         this_win = np.dot(h5_U[islice, comp_slice], ds_V)</span>
    <span class="c1">#</span>
    <span class="c1">#         clean_image[this_slice] += this_win.reshape(win_x, win_y)</span>
    <span class="c1">#</span>
    <span class="c1">#     clean_image = np.divide(clean_image, counts)</span>
    <span class="c1">#</span>
    <span class="c1">#     clean_image[np.isnan(clean_image)] = 0</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Calculate the removed noise and FFTs</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     removed_noise = np.reshape(self.h5_raw, clean_image.shape) - clean_image</span>
    <span class="c1">#</span>
    <span class="c1">#     fft_clean = np.fft.fft2(clean_image)</span>
    <span class="c1">#     fft_noise = np.fft.fft2(removed_noise)</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Create datasets for results, link them properly, and write them to file</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     clean_grp = MicroDataGroup(&#39;Cleaned_Image_&#39;, win_svd.name[1:])</span>
    <span class="c1">#     ds_clean = MicroDataset(&#39;Cleaned_Image&#39;, clean_image.reshape(self.h5_raw.shape))</span>
    <span class="c1">#     ds_noise = MicroDataset(&#39;Removed_Noise&#39;, removed_noise.reshape(self.h5_raw.shape))</span>
    <span class="c1">#     ds_fft_clean = MicroDataset(&#39;FFT_Cleaned_Image&#39;, fft_clean.reshape(self.h5_raw.shape))</span>
    <span class="c1">#     ds_fft_noise = MicroDataset(&#39;FFT_Removed_Noise&#39;, fft_noise.reshape(self.h5_raw.shape))</span>
    <span class="c1">#</span>
    <span class="c1">#     clean_grp.addChildren([ds_clean, ds_noise, ds_fft_clean, ds_fft_noise])</span>
    <span class="c1">#</span>
    <span class="c1">#     if isinstance(comp_slice, slice):</span>
    <span class="c1">#         clean_grp.attrs[&#39;components_used&#39;] = &#39;{}-{}&#39;.format(comp_slice.start, comp_slice.stop)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         clean_grp.attrs[&#39;components_used&#39;] = comp_slice</span>
    <span class="c1">#</span>
    <span class="c1">#     image_refs = self.hdf.writeData(clean_grp)</span>
    <span class="c1">#     self.hdf.flush()</span>
    <span class="c1">#</span>
    <span class="c1">#     h5_clean = get_h5_obj_refs([&#39;Cleaned_Image&#39;], image_refs)[0]</span>
    <span class="c1">#     h5_noise = get_h5_obj_refs([&#39;Removed_Noise&#39;], image_refs)[0]</span>
    <span class="c1">#     h5_fft_clean = get_h5_obj_refs([&#39;FFT_Cleaned_Image&#39;], image_refs)[0]</span>
    <span class="c1">#     h5_fft_noise = get_h5_obj_refs([&#39;FFT_Removed_Noise&#39;], image_refs)[0]</span>
    <span class="c1">#</span>
    <span class="c1">#     copy_attributes(self.h5_raw, h5_clean, skip_refs=False)</span>
    <span class="c1">#     copy_attributes(self.h5_raw, h5_noise, skip_refs=False)</span>
    <span class="c1">#     copy_attributes(self.h5_raw, h5_fft_clean, skip_refs=False)</span>
    <span class="c1">#     copy_attributes(self.h5_raw, h5_fft_noise, skip_refs=False)</span>
    <span class="c1">#</span>
    <span class="c1">#     self.h5_clean = h5_clean</span>
    <span class="c1">#     self.h5_noise = h5_noise</span>
    <span class="c1">#</span>
    <span class="c1">#     return h5_clean</span>

<div class="viewcode-block" id="ImageWindow.clean_and_build_batch"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.clean_and_build_batch">[docs]</a>    <span class="k">def</span> <span class="nf">clean_and_build_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebuild the Image from the SVD results on the windows</span>
<span class="sd">        Optionally, only use components less than n_comp.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_win : hdf5 Dataset, optional</span>
<span class="sd">            dataset containing the windowed image which SVD was performed on</span>
<span class="sd">        components : {int, iterable of int, slice} optional</span>
<span class="sd">            Defines which components to keep</span>
<span class="sd">            Default - None, all components kept</span>

<span class="sd">            Input Types</span>
<span class="sd">            integer : Components less than the input will be kept</span>
<span class="sd">            length 2 iterable of integers : Integers define start and stop of component slice to retain</span>
<span class="sd">            other iterable of integers or slice : Selection of component indices to retain</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        clean_wins : HDF5 Dataset</span>
<span class="sd">            the cleaned windows</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">h5_win</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_wins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;You must perform windowing on an image followed by SVD on the window before you can clean it.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">h5_win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_wins</span>
        <span class="k">elif</span> <span class="s1">&#39;Image Data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The windows must have the real space image data in them to rebuild.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cleaning the image by removing unwanted components.&#39;</span><span class="p">)</span>

        <span class="n">comp_slice</span> <span class="o">=</span> <span class="n">get_component_slice</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the 1st n_comp components from the SVD results</span>
<span class="sd">        on h5_win</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">win_name</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">win_svd</span> <span class="o">=</span> <span class="n">find_results_groups</span><span class="p">(</span><span class="n">h5_win</span><span class="p">,</span> <span class="s1">&#39;SVD&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">h5_S</span> <span class="o">=</span> <span class="n">win_svd</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span>
            <span class="n">h5_U</span> <span class="o">=</span> <span class="n">win_svd</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>
            <span class="n">h5_V</span> <span class="o">=</span> <span class="n">win_svd</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnstring</span> <span class="o">=</span> <span class="s1">&#39;SVD Results for </span><span class="si">{dset}</span><span class="s1"> were not found in </span><span class="si">{file}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dset</span><span class="o">=</span><span class="n">win_name</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">warnstring</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get basic windowing information from attributes of</span>
<span class="sd">        h5_win</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">im_x</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_x&#39;</span><span class="p">]</span>
        <span class="n">im_y</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_y&#39;</span><span class="p">]</span>
        <span class="n">win_x</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_x&#39;</span><span class="p">]</span>
        <span class="n">win_y</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_y&#39;</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize arrays to hold summed windows and counts for each position</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create slice object from the positions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ds_win_pos</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">h5_win</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">]][()]</span>
        <span class="n">win_slices</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">win_x</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">win_y</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_win_pos</span><span class="p">]</span>
        <span class="n">n_wins</span> <span class="o">=</span> <span class="n">ds_win_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a matrix to add when counting.</span>
<span class="sd">        h5_V is usually small so go ahead and take S.V</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">counts</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">ds_V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">h5_S</span><span class="p">[</span><span class="n">comp_slice</span><span class="p">]),</span> <span class="n">h5_V</span><span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">][</span><span class="n">comp_slice</span><span class="p">,</span> <span class="p">:])</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the size of a given batch that will fit in the available memory</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mem_per_win</span> <span class="o">=</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">free_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free_mem</span> <span class="o">/</span> <span class="n">mem_per_win</span><span class="p">)</span>
        <span class="n">batch_slices</span> <span class="o">=</span> <span class="n">gen_batches</span><span class="p">(</span><span class="n">n_wins</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructing in batches of </span><span class="si">{}</span><span class="s1"> windows.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loop over all batches.  Increment counts for window positions and</span>
<span class="sd">        add current window to total.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ibatch</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_slices</span><span class="p">):</span>
            <span class="n">ds_U</span> <span class="o">=</span> <span class="n">h5_U</span><span class="p">[</span><span class="n">batch</span><span class="p">,</span> <span class="n">comp_slice</span><span class="p">]</span>
            <span class="n">batch_wins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ds_U</span><span class="p">,</span> <span class="n">ds_V</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">ds_U</span>
            <span class="k">for</span> <span class="n">islice</span><span class="p">,</span> <span class="n">this_slice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">win_slices</span><span class="p">[</span><span class="n">batch</span><span class="p">]):</span>
                <span class="n">iwin</span> <span class="o">=</span> <span class="n">ibatch</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="n">islice</span>
                <span class="k">if</span> <span class="n">iwin</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">n_wins</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">per_done</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">iwin</span> <span class="o">/</span> <span class="n">n_wins</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructing Image...</span><span class="si">{}% -- s</span><span class="s1">tep # </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">per_done</span><span class="p">,</span> <span class="n">islice</span><span class="p">))</span>

                <span class="n">counts</span><span class="p">[</span><span class="n">this_slice</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ones</span>

                <span class="n">accum</span><span class="p">[</span><span class="n">this_slice</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_wins</span><span class="p">[</span><span class="n">islice</span><span class="p">]</span>

        <span class="n">clean_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>

        <span class="n">clean_image</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">clean_image</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;normalized&#39;</span><span class="p">]:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Renormalize the cleaned image</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">clean_image</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">clean_image</span><span class="p">)</span>
            <span class="n">clean_image</span> <span class="o">=</span> <span class="n">clean_image</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clean_image</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the removed noise and FFTs</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">removed_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="p">,</span> <span class="n">clean_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="n">clean_image</span>
        <span class="n">blackman_window_rows</span> <span class="o">=</span> <span class="n">blackman</span><span class="p">(</span><span class="n">clean_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">blackman_window_cols</span> <span class="o">=</span> <span class="n">blackman</span><span class="p">(</span><span class="n">clean_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fft_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">blackman_window_rows</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">clean_image</span> <span class="o">*</span> <span class="n">blackman_window_cols</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">fft_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span>
            <span class="n">blackman_window_rows</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">removed_noise</span> <span class="o">*</span> <span class="n">blackman_window_cols</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create datasets for results, link them properly, and write them to file</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">clean_grp</span> <span class="o">=</span> <span class="n">VirtualGroup</span><span class="p">(</span><span class="s1">&#39;Cleaned_Image_&#39;</span><span class="p">,</span> <span class="n">win_svd</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">ds_clean</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Cleaned_Image&#39;</span><span class="p">,</span> <span class="n">clean_image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">ds_noise</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Removed_Noise&#39;</span><span class="p">,</span> <span class="n">removed_noise</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">ds_fft_clean</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;FFT_Cleaned_Image&#39;</span><span class="p">,</span> <span class="n">fft_clean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">ds_fft_noise</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;FFT_Removed_Noise&#39;</span><span class="p">,</span> <span class="n">fft_noise</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">clean_grp</span><span class="o">.</span><span class="n">add_children</span><span class="p">([</span><span class="n">ds_clean</span><span class="p">,</span> <span class="n">ds_noise</span><span class="p">,</span> <span class="n">ds_fft_clean</span><span class="p">,</span> <span class="n">ds_fft_noise</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_slice</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">clean_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;components_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">comp_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clean_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;components_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_slice</span>

        <span class="n">image_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">clean_grp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">h5_clean</span> <span class="o">=</span> <span class="n">get_h5_obj_refs</span><span class="p">([</span><span class="s1">&#39;Cleaned_Image&#39;</span><span class="p">],</span> <span class="n">image_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h5_noise</span> <span class="o">=</span> <span class="n">get_h5_obj_refs</span><span class="p">([</span><span class="s1">&#39;Removed_Noise&#39;</span><span class="p">],</span> <span class="n">image_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h5_fft_clean</span> <span class="o">=</span> <span class="n">get_h5_obj_refs</span><span class="p">([</span><span class="s1">&#39;FFT_Cleaned_Image&#39;</span><span class="p">],</span> <span class="n">image_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h5_fft_noise</span> <span class="o">=</span> <span class="n">get_h5_obj_refs</span><span class="p">([</span><span class="s1">&#39;FFT_Removed_Noise&#39;</span><span class="p">],</span> <span class="n">image_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">copy_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="p">,</span> <span class="n">h5_clean</span><span class="p">,</span> <span class="n">skip_refs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">copy_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="p">,</span> <span class="n">h5_noise</span><span class="p">,</span> <span class="n">skip_refs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">copy_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="p">,</span> <span class="n">h5_fft_clean</span><span class="p">,</span> <span class="n">skip_refs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">copy_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="p">,</span> <span class="n">h5_fft_noise</span><span class="p">,</span> <span class="n">skip_refs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5_clean</span> <span class="o">=</span> <span class="n">h5_clean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_noise</span> <span class="o">=</span> <span class="n">h5_noise</span>

        <span class="k">return</span> <span class="n">h5_clean</span></div>

<div class="viewcode-block" id="ImageWindow.clean_and_build_separate_components"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.clean_and_build_separate_components">[docs]</a>    <span class="k">def</span> <span class="nf">clean_and_build_separate_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebuild the Image from the SVD results on the windows</span>
<span class="sd">        Optionally, only use components less than n_comp.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_win : hdf5 Dataset, optional</span>
<span class="sd">            dataset containing the windowed image which SVD was performed on</span>
<span class="sd">        components : {int, iterable of int, slice} optional</span>
<span class="sd">            Defines which components to keep</span>
<span class="sd">            Default - None, all components kept</span>
<span class="sd">            \n</span>
<span class="sd">            Input Types</span>
<span class="sd">            integer : Components less than the input will be kept</span>
<span class="sd">            length 2 iterable of integers : Integers define start and stop of component slice to retain</span>
<span class="sd">            other iterable of integers or slice : Selection of component indices to retain</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        clean_wins : HDF5 Dataset</span>
<span class="sd">            the cleaned windows</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">h5_win</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_wins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;You must perform windowing on an image followed by SVD on the window before you can clean it.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">h5_win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_wins</span>
        <span class="k">elif</span> <span class="s1">&#39;Image Data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The windows must have the real space image data in them to rebuild.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cleaning the image by removing unwanted components.&#39;</span><span class="p">)</span>
        <span class="n">comp_slice</span><span class="p">,</span> <span class="n">num_comps</span> <span class="o">=</span> <span class="n">get_component_slice</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the 1st n_comp components from the SVD results</span>
<span class="sd">        on h5_win</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">win_name</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">win_svd</span> <span class="o">=</span> <span class="n">find_results_groups</span><span class="p">(</span><span class="n">h5_win</span><span class="p">,</span> <span class="s1">&#39;SVD&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">h5_S</span> <span class="o">=</span> <span class="n">win_svd</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span>
            <span class="n">h5_U</span> <span class="o">=</span> <span class="n">win_svd</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>
            <span class="n">h5_V</span> <span class="o">=</span> <span class="n">win_svd</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnstring</span> <span class="o">=</span> <span class="s1">&#39;SVD Results for </span><span class="si">{dset}</span><span class="s1"> were not found in </span><span class="si">{file}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dset</span><span class="o">=</span><span class="n">win_name</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">warnstring</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get basic windowing information from attributes of</span>
<span class="sd">        h5_win</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">im_x</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_x&#39;</span><span class="p">]</span>
        <span class="n">im_y</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;image_y&#39;</span><span class="p">]</span>
        <span class="n">win_x</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_x&#39;</span><span class="p">]</span>
        <span class="n">win_y</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;win_y&#39;</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create slice object from the positions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ds_win_pos</span> <span class="o">=</span> <span class="n">h5_win</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">h5_win</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">]][()]</span>
        <span class="n">win_slices</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">win_x</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">win_y</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_win_pos</span><span class="p">]</span>
        <span class="n">n_wins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_win_pos</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Go ahead and take the dot product of S and V.  Get the number of components</span>
<span class="sd">        from the length of S</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ds_V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">h5_S</span><span class="p">[</span><span class="n">comp_slice</span><span class="p">]),</span> <span class="n">h5_V</span><span class="p">[</span><span class="s1">&#39;Image Data&#39;</span><span class="p">][</span><span class="n">comp_slice</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">num_comps</span> <span class="o">=</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize arrays to hold summed windows and counts for each position</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">,</span> <span class="n">num_comps</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span><span class="p">,</span> <span class="n">num_comps</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
        <span class="n">clean_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">im_x</span><span class="p">,</span> <span class="n">im_y</span><span class="p">,</span> <span class="n">num_comps</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the size of a given batch that will fit in the available memory</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mem_per_win</span> <span class="o">=</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_comps</span> <span class="o">+</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">free_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">ds_V</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">free_mem</span> <span class="o">/</span> <span class="n">mem_per_win</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s1">&#39;Not enough memory to perform Image Cleaning.&#39;</span><span class="p">)</span>
        <span class="n">batch_slices</span> <span class="o">=</span> <span class="n">gen_batches</span><span class="p">(</span><span class="n">n_wins</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructing in batches of </span><span class="si">{}</span><span class="s1"> windows.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loop over all batches.  Increment counts for window positions and</span>
<span class="sd">        add current window to total.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ibatch</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_slices</span><span class="p">):</span>
            <span class="n">ds_U</span> <span class="o">=</span> <span class="n">h5_U</span><span class="p">[</span><span class="n">batch</span><span class="p">,</span> <span class="n">comp_slice</span><span class="p">]</span>
            <span class="n">batch_wins</span> <span class="o">=</span> <span class="n">ds_U</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">ds_V</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">for</span> <span class="n">islice</span><span class="p">,</span> <span class="n">this_slice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">win_slices</span><span class="p">[</span><span class="n">batch</span><span class="p">]):</span>
                <span class="n">iwin</span> <span class="o">=</span> <span class="n">ibatch</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="n">islice</span>
                <span class="k">if</span> <span class="n">iwin</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">n_wins</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">per_done</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">iwin</span> <span class="o">/</span> <span class="n">n_wins</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reconstructing Image...</span><span class="si">{}% -- s</span><span class="s1">tep # </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">per_done</span><span class="p">,</span> <span class="n">iwin</span><span class="p">))</span>

                <span class="n">counts</span><span class="p">[</span><span class="n">this_slice</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ones</span>

                <span class="n">clean_image</span><span class="p">[</span><span class="n">this_slice</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_wins</span><span class="p">[</span><span class="n">islice</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">win_x</span><span class="p">,</span> <span class="n">win_y</span><span class="p">,</span> <span class="n">num_comps</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">ds_U</span><span class="p">,</span> <span class="n">ds_V</span>

        <span class="n">clean_image</span> <span class="o">/=</span> <span class="n">counts</span>
        <span class="k">del</span> <span class="n">counts</span>
        <span class="n">clean_image</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">clean_image</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create datasets for results, link them properly, and write them to file</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">clean_grp</span> <span class="o">=</span> <span class="n">VirtualGroup</span><span class="p">(</span><span class="s1">&#39;Cleaned_Image_&#39;</span><span class="p">,</span> <span class="n">win_svd</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">clean_chunking</span> <span class="o">=</span> <span class="n">calc_chunks</span><span class="p">([</span><span class="n">im_x</span> <span class="o">*</span> <span class="n">im_y</span><span class="p">,</span> <span class="n">num_comps</span><span class="p">],</span>
                                     <span class="n">clean_image</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">ds_clean</span> <span class="o">=</span> <span class="n">VirtualDataset</span><span class="p">(</span><span class="s1">&#39;Cleaned_Image&#39;</span><span class="p">,</span>
                                  <span class="n">data</span><span class="o">=</span><span class="n">clean_image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_x</span> <span class="o">*</span> <span class="n">im_y</span><span class="p">,</span> <span class="n">num_comps</span><span class="p">),</span>
                                  <span class="n">chunking</span><span class="o">=</span><span class="n">clean_chunking</span><span class="p">,</span>
                                  <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>

        <span class="n">clean_grp</span><span class="o">.</span><span class="n">add_children</span><span class="p">([</span><span class="n">ds_clean</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_slice</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">clean_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;components_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                                                <span class="n">comp_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clean_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;components_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_slice</span>

        <span class="n">image_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">clean_grp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">h5_clean</span> <span class="o">=</span> <span class="n">get_h5_obj_refs</span><span class="p">([</span><span class="s1">&#39;Cleaned_Image&#39;</span><span class="p">],</span> <span class="n">image_refs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h5_comp_inds</span> <span class="o">=</span> <span class="n">h5_clean</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">h5_U</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Spectroscopic_Indices&#39;</span><span class="p">]]</span>
        <span class="n">h5_comp_vals</span> <span class="o">=</span> <span class="n">h5_clean</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">h5_U</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Spectroscopic_Values&#39;</span><span class="p">]]</span>
        <span class="n">h5_pos_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">]]</span>
        <span class="n">h5_pos_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Position_Values&#39;</span><span class="p">]]</span>

        <span class="n">link_as_main</span><span class="p">(</span><span class="n">h5_clean</span><span class="p">,</span> <span class="n">h5_pos_inds</span><span class="p">,</span> <span class="n">h5_pos_vals</span><span class="p">,</span> <span class="n">h5_comp_inds</span><span class="p">,</span> <span class="n">h5_comp_vals</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h5_clean</span> <span class="o">=</span> <span class="n">h5_clean</span>

        <span class="k">return</span> <span class="n">h5_clean</span></div>

<div class="viewcode-block" id="ImageWindow.plot_clean_image"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.plot_clean_image">[docs]</a>    <span class="k">def</span> <span class="nf">plot_clean_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_clean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span>
                         <span class="n">save_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the cleaned image stored in the HDF5 dataset h5_clean</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_clean : HDF5 dataset, optional</span>
<span class="sd">            cleaned image to be plotted</span>
<span class="sd">        image_path : str, optional</span>
<span class="sd">            path to save cleaned image file</span>
<span class="sd">            Default None, &#39;_clean&#39; will be appened to the name of the input image</span>
<span class="sd">        image_type : str, optional</span>
<span class="sd">            image format to save the cleaned image as</span>
<span class="sd">            Default &#39;png&#39;, all formats recognized by matplotlib.pyplot.imsave</span>
<span class="sd">            are allowed</span>
<span class="sd">        save_plots : Boolean, pptional</span>
<span class="sd">            If true, the image will be saved to image_path</span>
<span class="sd">            with the extention specified by image_type</span>
<span class="sd">            Default True</span>
<span class="sd">        show_plots : Boolean, optional</span>
<span class="sd">            If true, the image will be displayed on the screen</span>
<span class="sd">            Default False</span>
<span class="sd">        cmap : str, optional</span>
<span class="sd">            matplotlib colormap string designation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        clean_image : Axis_Image</span>
<span class="sd">            object holding the plot of the cleaned image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">h5_clean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_clean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;You must clean an image before it can be plotted.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">h5_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_clean</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the position indices of h5_clean and reshape the flattened image back</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h5_pos</span> <span class="o">=</span> <span class="n">h5_clean</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">h5_clean</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">]][()]</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">h5_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">h5_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Position Indices dataset does not exist</span>
<span class="sd">        Assume square image</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h5_clean</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="n">x_pix</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">h5_clean</span><span class="p">[()]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">y_pix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image_dir</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">basename</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s1">&#39;_clean.&#39;</span> <span class="o">+</span> <span class="n">image_type</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">image_type</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

        <span class="n">clean_image</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">clean_image</span></div>

<div class="viewcode-block" id="ImageWindow.window_size_extract"><a class="viewcode-back" href="../../../_autosummary/pycroscopy.processing.html#pycroscopy.processing.image_processing.ImageWindow.window_size_extract">[docs]</a>    <span class="k">def</span> <span class="nf">window_size_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_peaks</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take the normalized image and extract from it an optimal window size</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_peaks : int, optional</span>
<span class="sd">            number of peaks to use during least squares fit</span>
<span class="sd">            Default 2</span>
<span class="sd">        save_plots : Boolean, optional</span>
<span class="sd">            If True then a plot showing the quality of the fit will be</span>
<span class="sd">            generated and saved to disk.  Ignored if do_fit is false.</span>
<span class="sd">            Default True</span>
<span class="sd">        show_plots : Boolean, optional</span>
<span class="sd">            If True then a plot showing the quality of the fit will be</span>
<span class="sd">            generated and shown on screen.  Ignored if do_fit is false.</span>
<span class="sd">            Default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        window_size : int</span>
<span class="sd">            Optimal window size in pixels</span>
<span class="sd">        psf_width : int</span>
<span class="sd">            Estimate atom spacing in pixels</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__gauss_fit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            simple gaussian fitting function</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">g</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">g</span>

        <span class="k">def</span> <span class="nf">__gauss_chi</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Simple chi-squared fit</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">__gauss_fit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

            <span class="n">chi2</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">gauss</span><span class="p">)</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="k">return</span> <span class="n">chi2</span>

        <span class="n">h5_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5_raw</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining appropriate window size from image.&#39;</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Normalize the image</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">immin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">h5_main</span><span class="p">)</span>
        <span class="n">immax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h5_main</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">h5_main</span> <span class="o">-</span> <span class="n">immin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">immax</span> <span class="o">-</span> <span class="n">immin</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reshape the image based on the position indices</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h5_pos</span> <span class="o">=</span> <span class="n">h5_main</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="n">h5_main</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Position_Indices&#39;</span><span class="p">]][()]</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">h5_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">h5_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Position Indices dataset does not exist</span>
<span class="sd">            Assume square image</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h5_main</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="n">x_pix</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">y_pix</span><span class="p">])</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Perform an fft on the normalize image </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">im_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__hamming</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Simple hamming filter</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">u_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
            <span class="n">v_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">u_mat</span><span class="p">,</span> <span class="n">v_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">u_vec</span><span class="p">,</span> <span class="n">v_vec</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
            <span class="n">h_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u_mat</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v_mat</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">4.0</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">h_filter</span><span class="p">)</span>

        <span class="n">im2</span> <span class="o">=</span> <span class="n">image</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">fim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">__hamming</span><span class="p">(</span><span class="n">im2</span><span class="p">)))</span>

        <span class="n">imrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">im_shape</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">im_shape</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">uu</span><span class="p">,</span> <span class="n">vv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">imrange</span><span class="p">,</span> <span class="n">imrange</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find max at each radial distance from the center</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">r_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im_shape</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">r_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="n">im_shape</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">r_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">r_n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="n">r_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">uu</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">vv</span><span class="p">)</span>

        <span class="n">fimabs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fim</span><span class="p">)</span>
        <span class="n">fimabs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">r_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">r_vec</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">r_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">r_mat</span> <span class="o">&gt;=</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r_mat</span> <span class="o">&lt;=</span> <span class="n">r2</span><span class="p">))</span>
            <span class="n">fimabs_max</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fimabs</span><span class="p">[</span><span class="n">r_ind</span><span class="p">])</span>

        <span class="n">r_vec</span> <span class="o">=</span> <span class="n">r_vec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">r_max</span> <span class="o">-</span> <span class="n">r_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_n</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find local maxima</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">local_max</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fimabs_max</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fimabs_max</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fimabs_max</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fimabs_max</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fimabs_max</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">local_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get points corresponding to local maxima</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">r_loc_max_vec</span> <span class="o">=</span> <span class="n">r_vec</span><span class="p">[</span><span class="n">local_max</span><span class="p">]</span>
        <span class="n">fimabs_loc_max_vec</span> <span class="o">=</span> <span class="n">fimabs_max</span><span class="p">[</span><span class="n">local_max</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove points below the radius of the tallest peak</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fimabs_loc_max_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">fimabs_loc_max_vec</span><span class="p">)</span>
        <span class="n">fimabs_loc_max_vec</span> <span class="o">=</span> <span class="n">fimabs_loc_max_vec</span><span class="p">[</span><span class="n">fimabs_loc_max_ind</span><span class="p">:]</span>
        <span class="n">r_loc_max_vec</span> <span class="o">=</span> <span class="n">r_loc_max_vec</span><span class="p">[</span><span class="n">fimabs_loc_max_ind</span><span class="p">:]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sort the peaks from largest to smallest</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sort_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">fimabs_loc_max_vec</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fimabs_sort</span> <span class="o">=</span> <span class="n">fimabs_loc_max_vec</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">]</span>
        <span class="n">r_sort</span> <span class="o">=</span> <span class="n">r_loc_max_vec</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check to ensure there are at least 2 peaks left.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fimabs_sort</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Only one peak in sorted vector.  Simple estimate being used.&#39;</span><span class="p">)</span>
            <span class="n">window_size</span> <span class="o">=</span> <span class="n">im_shape</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

            <span class="n">window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">im_shape</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">))</span>

            <span class="n">window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">window_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>

            <span class="n">gauss_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fimabs_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">psf_width</span> <span class="o">=</span> <span class="n">im_shape</span> <span class="o">/</span> <span class="n">gauss_guess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="k">return</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">psf_width</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Only use specified number of peaks</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fimabs_sort</span> <span class="o">=</span> <span class="n">fimabs_sort</span><span class="p">[:</span><span class="n">num_peaks</span><span class="p">]</span>
        <span class="n">r_sort</span> <span class="o">=</span> <span class="n">r_sort</span><span class="p">[:</span><span class="n">num_peaks</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fit to a gaussian</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gauss_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fimabs_sort</span><span class="p">),</span> <span class="n">r_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">fit_vec</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">__gauss_chi</span><span class="p">,</span>
                                                       <span class="n">gauss_guess</span><span class="p">,</span>
                                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">r_sort</span><span class="p">,</span> <span class="n">fimabs_sort</span><span class="p">),</span>
                                                       <span class="n">full_output</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                       <span class="n">maxfev</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>

        <span class="n">psf_width</span> <span class="o">=</span> <span class="n">im_shape</span> <span class="o">/</span> <span class="n">fit_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">if</span> <span class="n">save_plots</span> <span class="ow">or</span> <span class="n">show_plots</span><span class="p">:</span>
            <span class="n">guess_vec</span> <span class="o">=</span> <span class="n">__gauss_fit</span><span class="p">(</span><span class="n">gauss_guess</span><span class="p">,</span> <span class="n">r_vec</span><span class="p">)</span>
            <span class="n">fit_vec</span> <span class="o">=</span> <span class="n">__gauss_fit</span><span class="p">(</span><span class="n">fit_vec</span><span class="p">,</span> <span class="n">r_vec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__plot_window_fit</span><span class="p">(</span><span class="n">r_vec</span><span class="p">,</span> <span class="n">r_sort</span><span class="p">,</span> <span class="n">fimabs_max</span><span class="p">,</span> <span class="n">fimabs_sort</span><span class="p">,</span>
                                   <span class="n">guess_vec</span><span class="p">,</span> <span class="n">fit_vec</span><span class="p">,</span> <span class="n">save_plots</span><span class="p">,</span> <span class="n">show_plots</span><span class="p">)</span>

        <span class="n">window_size</span> <span class="o">=</span> <span class="n">im_shape</span> <span class="o">/</span> <span class="p">(</span><span class="n">r_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="n">window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">im_shape</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">))</span>

        <span class="n">window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">window_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">psf_width</span></div>

    <span class="k">def</span> <span class="nf">__plot_window_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_vec</span><span class="p">,</span> <span class="n">r_sort</span><span class="p">,</span> <span class="n">fft_absimage</span><span class="p">,</span> <span class="n">fft_abssort</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span>
                          <span class="n">save_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a plot showing the quality of the least-squares fit to the peaks of the FFT of the image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r_vec : numpy array</span>
<span class="sd">            1D array of unsorted radii in pixels</span>
<span class="sd">        r_sort : numpy array</span>
<span class="sd">            1D array of the sorted radii</span>
<span class="sd">        fft_absimage : numpy array</span>
<span class="sd">            1D array of the absolute value of the FFT of the normalized image</span>
<span class="sd">        fft_abssort : numpy array</span>
<span class="sd">            1D array of FFT_absimage after being sorted to match r_sort</span>
<span class="sd">        guess :  numpy array</span>
<span class="sd">            1D array of the gaussian guess</span>
<span class="sd">        fit : numpy array</span>
<span class="sd">            1D array of the fitted gaussian</span>
<span class="sd">        save_plots : Boolean, optional</span>
<span class="sd">            If True then a plot showing the quality of the fit will be</span>
<span class="sd">            generated and saved to disk.</span>
<span class="sd">            Default True</span>
<span class="sd">        show_plots : Boolean, optional</span>
<span class="sd">            If True then a plot showing the quality of the fit will be</span>
<span class="sd">            generated and shown on screen.</span>
<span class="sd">            Default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt1</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">r_vec</span><span class="p">,</span> <span class="n">fft_absimage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;magnitude&#39;</span><span class="p">)</span>
        <span class="n">plt2</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">r_sort</span><span class="p">,</span> <span class="n">fft_abssort</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;chosen peaks&#39;</span><span class="p">)</span>
        <span class="n">plt3</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">r_vec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;guess&#39;</span><span class="p">)</span>
        <span class="n">plt4</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">r_vec</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;radius [pixels]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;max magnitude&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">plt1</span><span class="p">,</span> <span class="n">plt2</span><span class="p">,</span> <span class="n">plt3</span><span class="p">,</span> <span class="n">plt4</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">save_plots</span><span class="p">:</span>
            <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">basename</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">plotname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">basename</span><span class="p">,</span> <span class="s1">&#39;window_fit&#39;</span><span class="p">])</span>
            <span class="n">plotpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">plotname</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        <span class="c1"># plt.close(fig)</span>


<div class="viewcode-block" id="radially_average_correlation"><a class="viewcode-back" href="../../../_autosummary/_autosummary/pycroscopy.processing.image_processing.html#pycroscopy.processing.image_processing.radially_average_correlation">[docs]</a><span class="k">def</span> <span class="nf">radially_average_correlation</span><span class="p">(</span><span class="n">data_mat</span><span class="p">,</span> <span class="n">num_r_bin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the radially average correlation functions for a given 2D image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_mat : 2D real numpy array</span>
<span class="sd">        Image to analyze</span>
<span class="sd">    num_r_bin : unsigned int</span>
<span class="sd">        Number of spatial bins to analyze</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    a_mat : 2D real numpy array</span>
<span class="sd">        Noise spectrum of the image</span>
<span class="sd">    a_rad_avg_vec : 1D real numpy array</span>
<span class="sd">        Average value of the correlation as a function of feature size</span>
<span class="sd">    a_rad_max_vec : 1D real numpy array</span>
<span class="sd">        Maximum value of the correlation as a function of feature size</span>
<span class="sd">    a_rad_min_vec : 1D real numpy array</span>
<span class="sd">        Minimum value of the correlation as a function of feature size</span>
<span class="sd">    a_rad_std_vec : 1D real numpy array</span>
<span class="sd">        Standard deviation of the correlation as a function of feature size</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_size</span> <span class="o">=</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_size</span> <span class="o">=</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_size</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_size</span><span class="p">))</span>
    <span class="n">r_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_mesh</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y_mesh</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">s_mat</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">data_mat</span><span class="p">))))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">a_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">s_mat</span><span class="p">))))</span>

    <span class="n">min_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a_mat</span><span class="p">)</span>
    <span class="n">a_mat</span> <span class="o">=</span> <span class="n">a_mat</span> <span class="o">-</span> <span class="n">min_a</span>
    <span class="n">max_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a_mat</span><span class="p">)</span>
    <span class="n">a_mat</span> <span class="o">=</span> <span class="n">a_mat</span> <span class="o">/</span> <span class="n">max_a</span>

    <span class="n">a_vec</span> <span class="o">=</span> <span class="n">a_mat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># bin results based on r</span>
    <span class="n">a_rad_avg_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_r_bin</span><span class="p">)</span>
    <span class="n">a_rad_max_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a_rad_avg_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">a_rad_min_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a_rad_avg_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">a_rad_std_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a_rad_avg_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">r_bin_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a_rad_avg_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_r_bin</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r_bin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_r_bin</span><span class="p">)):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">r_vec</span> <span class="o">&lt;</span> <span class="n">r_bin</span> <span class="o">+</span> <span class="n">step</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r_vec</span> <span class="o">&gt;</span> <span class="n">r_bin</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a_rad_avg_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">a_rad_min_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">a_rad_max_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">a_rad_std_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a_bin</span> <span class="o">=</span> <span class="n">a_vec</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="n">a_rad_avg_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a_bin</span><span class="p">)</span>
            <span class="n">a_rad_min_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a_bin</span><span class="p">)</span>
            <span class="n">a_rad_max_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a_bin</span><span class="p">)</span>
            <span class="n">a_rad_std_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">a_bin</span><span class="p">)</span>
        <span class="n">r_bin_vec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_bin</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">step</span>

    <span class="k">return</span> <span class="n">a_mat</span><span class="p">,</span> <span class="n">a_rad_avg_vec</span><span class="p">,</span> <span class="n">a_rad_max_vec</span><span class="p">,</span> <span class="n">a_rad_min_vec</span><span class="p">,</span> <span class="n">a_rad_std_vec</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Suhas Somnath, Chris Smith, Stephen Jesse, Numan Laanait.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.60.2',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>